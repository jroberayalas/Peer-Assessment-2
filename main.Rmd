---
title: "Impact of Weather Events in Health and Economics in the US"
author: "Jose Roberto Ayala Solares"
output: html_document
---

## Synopsis

Storms and other severe weather events can cause both public health and economic problems for communities and municipalities. Many severe events can result in fatalities, injuries, and property damage, and preventing such outcomes to the extent possible is a key concern.

This project involves exploring the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.The events in the database start in the year 1950 and end in November 2011. In the earlier years of the database there are generally fewer events recorded, most likely due to a lack of good records. More recent years should be considered more complete.

In particular, we are concerned in answering the following questions:

1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?
2. Across the United States, which types of events have the greatest economic consequences?

## Data Processing

The data that we will use for the analysis can be downloaded from the following [link](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2). The code below checks if the data has been downloaded. If not, it downloads it and saves it in the current directory. The data is then read into R and store for future use.

```{r}
# Check if dataset already exists
if (!file.exists("StormData.csv.bz2")) {
    fileURL <- 'https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2'
    download.file(fileURL, destfile='StormData.csv.bz2', method = 'curl')
}

# Read data
stormData <- read.csv(bzfile("StormData.csv.bz2"))

# Record date of download
downloadedData <- date()
```

For this analysis, the data was downloaded on `r downloadedData`.

The data consists of **902297** observations, each with **37** variables. The names of each of the variables are:

```{r}
names(stormData)
```

The class of each of the variables is summarized below:

```{r}
str(stormData)
```

From the structure of the data, we can observe that the variables **EVTYPE** (type of event), **FATALITIES** (number of fatalities), and **INJURIES** (number of injuries) are ready to be used for analysis. First, we activate the libraries 'dplyr' and 'ggplot2'. Then we count the number of fatalities and injuries based on the type of event, arrange them in descending order, and store them in two different data frames. From each, we select only the top 10 causes for visualization purposes.

```{r}
library(dplyr)
library(ggplot2)

fatalities <- stormData %>% 
    count(EVTYPE, wt = FATALITIES, sort = TRUE) %>% 
    slice(1:10)

injuries <- stormData %>% 
    count(EVTYPE, wt = INJURIES, sort = TRUE) %>% 
    slice(1:10)
```

However, the variables **PROPDMG** (property damage) and **PROPDMGEXP** (property damage exponential) require some processing before they can be used for analysis. These two variables work in the following way: tha variable **PROPDMGEXP** contains the number of zeros that follows the quantity stored in the variable **PROPDMG**. A summary on the variable **PROPDMGEXP** shows us the following:

```{r}
with(stormData, summary(PROPDMGEXP))
```

Apart from the numbers 0-8, there are a couple of letters and symbols. We transform these using the following code, which create a new variable called **TOTAL.COST**:

```{r}
exponents <- vector(mode = "numeric", length = dim(stormData)[1])
exponents[stormData$PROPDMGEXP == "H" | stormData$PROPDMGEXP == "h"] <- 2
exponents[stormData$PROPDMGEXP == "K" | stormData$PROPDMGEXP == "k"] <- 3
exponents[stormData$PROPDMGEXP == "M" | stormData$PROPDMGEXP == "m"] <- 6
exponents[stormData$PROPDMGEXP == "B" | stormData$PROPDMGEXP == "b"] <- 9
stormData <- stormData %>%
    mutate(TOTAL.COST = PROPDMG * 10 ^ exponents)
```

## Results

Using the data frames `fatalities` and *injuries* created in the previous section, we can obtain the following histograms. Both histograms agree that the weather event with more fatalities and injuries are **Tornadoes** with 5633 fatalities and 91346 injuries respectively.

```{r}
ggplot(data = fatalities[1:10, ], aes(x = reorder(EVTYPE, count), y = count )) + 
    geom_bar(stat = "identity", aes(fill = count)) +
    scale_fill_continuous(low = "blue", high = "red") +
    coord_flip() +
    ylab("Number of Fatalities") +
    xlab("Type of Event") +
    ggtitle("Top 10 Weather Events for Fatalities")
```

```{r}
ggplot(data = injuries[1:10, ], aes(x = reorder(EVTYPE, count), y = count )) + 
    geom_bar(stat = "identity", aes(fill = count)) +
    scale_fill_continuous(low = "blue", high = "red") +
    coord_flip() +
    ylab("Number of Injuries") +
    xlab("Type of Event") +
    ggtitle("Top 10 Weather Events for Injuries")
```

